importScripts(["./deepCompare.js"]);let CONFIG={interval:1e3,pulse:10,host:"http://localhost:8000/",stop_on_error:!0};const current_data={};let is_running=!1,to_stop=!1,hang_up=!1;const check_diff=function(t){let e=Object.assign({},current_data),a=[];return Object.values(t).forEach(function(t){let s=t.id;e.hasOwnProperty(s)?(deepCompare(t,e[s])||a.push({"data-id":s,"data-action":"modified"}),delete e[s]):a.push({"data-id":s,"data-action":"added"})}),a.concat(Object.keys(e).map(function(t){return{"data-id":t,"data-action":"deleted"}}))},sendMsg=function(t,e){self.postMessage({type:t,body:e})},stop=function(){to_stop=!0},start=async function(){if(to_stop)return;let t=new Date().getTime(),e;try{e=await fetch(CONFIG.host,{method:"GET",cache:"no-cache"})}catch(a){sendMsg("crash","unable to resolve response status"),stop();return}if(e.ok){let s;try{s=await e.json()}catch(r){sendMsg("crash","unable to resolve response status"),stop();return}let n=check_diff(s);Object.keys(current_data).forEach(function(t){delete current_data[t]}),s.forEach(function(t){current_data[t.id]=t}),n.forEach(function(t){if("deleted"==t["data-action"]){sendMsg(t["data-action"],{id:t["data-id"]});return}sendMsg(t["data-action"],{id:t["data-id"],content:current_data[t["data-id"]]})})}switch(e.status){case 400:if(sendMsg("error","bad-request"),CONFIG.stop_on_error){stop();return}break;case 200:break;case 409:if(sendMsg("error","conflict"),CONFIG.stop_on_error){stop();return}break;case 404:if(sendMsg("error","not-found"),CONFIG.stop_on_error){stop();return}break;default:sendMsg("crash","unable to resolve response status"),stop();return}let o=self.setInterval(function(){!hang_up&&new Date().getTime()-t>=CONFIG.interval&&(to_stop||start(),self.clearInterval(o))},CONFIG.pulse)};self.addEventListener("message",t=>{let e=t.data.type,a=t.data.body;if("config"==e){CONFIG=a;return}if("command"==!e){stop(),self.postMessage({type:"error",body:"No available method"});return}switch(a){case"start":is_running||(is_running=!0,start());break;case"stop":stop();break;case"pause":hang_up=!0;break;case"resume":hang_up=!1}});
